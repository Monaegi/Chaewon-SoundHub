{% extends 'base.html' %}
{% load static %}

{% block title %}
{% endblock title %}

{% block links %}
    <link rel="stylesheet" href="{% static 'css/post-detail.css' %}">
{% endblock links %}

{% block scripts %}
{% endblock scripts %}

{% block content %}

    <div class="container contents">
        <div class="post-detail-contents">

            <!-- master track -->
            <div class="post-master-track" id="track-{{ post.pk }}-master" data-pk="{{ post.pk }}" data-type="track">
                <!-- master track audio -->
                {% if post.master_track.name == "" %}
                {% else %}
                    <audio preload="metadata" id="track-{{ post.pk }}-audio-master" class="audio-file" data-target="track-{{ post.pk }}-master" onplay="addToPlaylist(this)" ontimeupdate="updateAudioInfo(this);updatePlayerProgress(this)" onended="resetWaveform(this)" onloadedmetadata="setTotalDuration(this)">
                        <source src="{{ post.master_track.url }}">
                    </audio>
                {% endif %}
                <!-- master track post image-->
                <div class="track-img">
                    {% if post.post_img.name == '' %}
                        <img class="track-post-img" src="{% static 'img/default-post-img.png' %}" alt="" style="width: 50%;object-fit: contain;text-align: center;">
                    {% else %}
                        <img class="track-post-img" src="{{ post.post_img.url }}" alt="">
                    {% endif %}
                </div>
                <!-- post title & author -->
                <div class="master-track-info">
                    <div draggable="false" id="play-btn-{{ post.pk }}" class="master-track-play-btn play-btn" data-target="track-{{ post.pk }}-audio-master" onclick="loadAudio(this);playAudio();updatePlayerPostInfo();"><i class="fas fa-play-circle fa-3x"></i></div>
                    <h1 class="track-title">{{ post.title|truncatechars:30 }}</h1>
                    <a href="{% url 'views:user:user-detail' pk=post.author.pk %}"><p class="track-author">{{ post.author }}</p></a>
                    <!-- track duration -->
                    <div class="playtime">
                        <span id="playtime-current-{{ track.pk }}" class="track-duration-current">00:00</span> |
                        <span id="playtime-total-{{ track.pk }}" class="track-duration-total">00:00</span>
                    </div>
                </div>
                <!-- master track waveform-->
                <div class="master-track-waveform">
                    {% if post.master_track_waveform_base.name == "" %}
                        <div class="no-master-track">
                            <p class="line1">No master track</p>
                            <p class="line2">Mix tracks to create master track</p>
                        </div>
                    {% else %}
                        <img class="master-track-waveform-base post-detail-waveform back-image" onclick="seekTrack(event)" src="{{ post.master_track_waveform_base.url }}">
                        <div class="master-waveform-cover-cutter cutter">
                            <img class="master-track-waveform-cover post-detail-waveform" src="{{ post.master_track_waveform_cover.url }}" alt="">
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="author-track-header track-collapse">
                <span>Original Track <span class="collapse-icon" onclick="collapseTrack(this, $('.post-author-track'))"><i class="far fa-minus-square"></i></span></span>
            </div>

            <!-- author track -->
            <div class="post-author-track post-track" data-instrument="{{ post.instrument }}" id="track-{{ post.pk }}" data-pk="{{ post.pk }}" data-type="track">

                <audio preload="metadata" id="track-{{ post.pk }}-audio" class="audio-file" data-target="track-{{ post.pk }}" ontimeupdate="updateAudioInfo(this, false);updatePlayerProgress(this)" onended="resetWaveform(this)" onloadedmetadata="setTotalDuration(this)">
                    <source src="{{ post.author_track.url }}">
                </audio>

                <div class="instrument-img-mask"></div>
                <a href="{% url 'views:user:user-detail' pk=post.author.pk %}">
                    {% if post.author.profile_img.name == "" %}
                        <div class="track-profile-img" style="background-image:url({% static 'img/default-profile.png' %})"></div>
                    {% else %}
                        <div class="track-profile-img" style="background-image:url({{ post.author.profile_img.url }})"></div>
                    {% endif %}
                </a>
                <div class="track-info">
                    <div draggable="false" id="play-btn-{{ post.pk }}" class="track-play-btn play-btn" data-target="track-{{ post.pk }}-audio" onclick="loadAudio(this);playAudio();updatePlayerPostInfo();"><i class="fas fa-play-circle fa-3x"></i></div>
                    <h1 class="track-title">{{ post.instrument }} Track</h1>
                    <a href="{% url 'views:user:user-detail' pk=post.author.pk %}"><p class="track-author">by {{ post.author }}</p></a>
                    <!-- track duration -->
                    <div class="playtime">
                        <span id="playtime-current-{{ track.pk }}" class="track-duration-current">00:00</span> |
                        <span id="playtime-total-{{ track.pk }}" class="track-duration-total">00:00</span>
                    </div>
                </div>

                <!-- author track waveform -->
                {% if post.author_track_waveform_base.name == "" %}
                {% else %}
                    <div class="track-waveform">
                        <img class="track-waveform-base post-detail-waveform back-image" draggable="false" onclick="seekTrack(event)" src="{{ post.author_track_waveform_base.url }}">
                        <div class="waveform-cover-cutter cutter">
                            <img class="track-waveform-cover post-detail-waveform" src="{{ post.author_track_waveform_cover.url }}" alt="">
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="track-header track-collapse">
                <span>Mixed Tracks <span class="collapse-icon" onclick="collapseTrack(this, $('.post-tracks'))"><i class="far fa-minus-square"></i></span></span>
            </div>

            <!-- mixed tracks -->
            <div class="post-tracks">
                {% if mixed %}
                    {% for comment in mixed %}
                        <div class="post-track" data-instrument="{{ comment.instrument }}" id="comment-{{ comment.pk }}" data-pk="{{ comment.pk }}" data-type="track">

                            <audio id="comment-track-{{ comment.pk }}" class="comment-track audio-file" preload="metadata" ontimeupdate="updateAudioInfo(this, false);updatePlayerProgress(this)" onended="resetWaveform(this)" onloadedmetadata="setTotalDuration(this)">
                                <source src="{{ comment.comment_track.url }}">
                            </audio>

                            <div class="instrument-img-mask"></div>
                            <a href="{% url 'views:user:user-detail' pk=comment.author.pk %}">
                                {% if comment.author.profile_img.name == "" %}
                                    <img class="track-post-img track-profile-img" src="{% static 'img/default-profile.png' %}">
                                {% else %}
                                    <img class="track-post-img track-profile-img" src="{{ comment.author.profile_img.url }}">
                                {% endif %}
                            </a>

                            <div class="track-info">
                                <!-- PLAY BTN -->
                                <div draggable="false" id="comment-play-btn-{{ comment.pk }}" data-target="comment-track-{{ comment.pk }}" class="track-play-btn play-btn" onclick="loadAudio(this);playAudio();updatePlayerPostInfo();"><i class="fas fa-play-circle fa-3x"></i></div>
                                <h1 class="track-title">{{ comment.instrument }} Track</h1>
                                <a href="{% url 'views:user:user-detail' pk=comment.author.pk %}"><p class="track-author">by {{ comment.author }}</p></a>
                                <!-- track duration -->
                                <div class="playtime">
                                    <span id="playtime-current-{{ track.pk }}" class="track-duration-current">00:00</span> |
                                    <span id="playtime-total-{{ track.pk }}" class="track-duration-total">00:00</span>
                                </div>
                            </div>

                            <!-- track waveform -->
                            {% if comment.comment_track_waveform_base.name == "" %}
                            {% else %}
                                <div class="track-waveform">
                                    <img class="track-waveform-base post-detail-waveform back-image" draggable="false" onclick="seekTrack(event)" src="{{ comment.comment_track_waveform_base.url }}">
                                    <div class="waveform-cover-cutter cutter">
                                        <img class="track-waveform-cover post-detail-waveform" src="{{ comment.comment_track_waveform_cover.url }}" alt="">
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-tracks">
                        <span>No Mixed Tracks</span>
                    </div>
                {% endif %}
            </div>

            <div class="track-header track-collapse">
                <span>Comment Tracks <span class="collapse-icon" onclick="collapseTrack(this, $('.post-comment-tracks'))"><i class="far fa-minus-square"></i></span></span>
            </div>

            <div class="post-comment-tracks">
                <div class="instruments-tabs">
                    <button class="guitar-tab tab-btns tab-clicked">Guitar</button>
                    <button class="bass-tab tab-btns">Bass</button>
                    <button class="drums-tab tab-btns">Drums</button>
                    <button class="keys-tab tab-btns">Keyboard</button>
                    <button class="vocal-tab tab-btns">Vocal</button>
                    <button class="others-tab tab-btns">Others</button>
                </div>

                <div data-instrument="Guitar" class="instrument-comment-track tab-opened">
                    {% if not guitar %}
                        <div class="no-tracks">
                            <span>No Guitar Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in guitar %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>

                <div data-instrument="Bass" class="instrument-comment-track">
                    {% if not bass %}
                        <div class="no-tracks">
                            <span>No Bass Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in bass %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>

                <div data-instrument="Drums" class="instrument-comment-track">
                    {% if not drums %}
                        <div class="no-tracks">
                            <span>No Drums Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in drums %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>

                <div data-instrument="Keyboard" class="instrument-comment-track">
                    {% if not keyboard %}
                        <div class="no-tracks">
                            <span>No Keyboard Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in keyboard %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>

                <div data-instrument="Vocal" class="instrument-comment-track">
                    {% if not vocal %}
                        <div class="no-tracks">
                            <span>No Vocal Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in vocal %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>

                <div data-instrument="Others" class="instrument-comment-track">
                    {% if not others %}
                        <div class="no-tracks">
                            <span>No Other Tracks</span>
                        </div>
                    {% endif %}
                    {% for comment in others %}
                        {% include 'post-detail/comment-tracks.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var inst = $(".post-track");

            inst.each(function(index, item) {
                var static_dir = "{% static 'img/instruments' %}";
                var pattern = /(.*[/]img[/]instruments)/i;

                var img_url = static_dir.match(pattern)[1] + "/" + $(item).data("instrument") + ".jpg";

                var inst_dir = "url(" + img_url + ")";

                $(item).css("background-image", inst_dir);
            });
        });

        function collapseTrack(self, div) {
            var icon = $(self).find("[data-fa-processed]");

            icon.toggleClass("fa-minus-square fa-plus-square");
            div.toggleClass("collapse")

        }

        $(".tab-btns").on("click", function() {
            showInstrumentTracks($(this).text())
        });

        function showInstrumentTracks (instrument) {
            var tabs = $(".tab-btns");
            var comments = $(".instrument-comment-track");

            tabs.removeClass("tab-clicked");
            comments.removeClass("tab-opened");

            tabs.each(function(index, item) {
                if ($(item).text() === instrument) {
                    $(item).addClass("tab-clicked")
                }
            });

            comments.each(function(index, item) {
                if ($(item).attr("data-instrument") === instrument) {
                    $(item).addClass("tab-opened")
                }
            })

        }
    </script>

    <script src="{% static 'js/profile/comment-waveform.js' %}"></script>


{% endblock content %}